<h2 class="mb-5">Empreendimentos</h2>

<div class="btn-group mb-4" role="group">
	<a href="/dashboard/empreendimentos/create" class="btn btn-outline-success" role="button" data-bs-toggle="button">Adicionar</a>
	<a href="/dashboard/empreendimentos" class="btn btn-outline-primary" role="button" data-bs-toggle="button">Publicados</a>
	<a href="/dashboard/empreendimentos?status=false" class="btn btn-outline-warning" role="button" data-bs-toggle="button">Não publicados</a>
</div>

<table class="table table-striped table-dark table-hover table-bordered table-sm">
	<thead>
		<tr>
			<th scope="col">Título do Anúncio</th>
			<th scope="col">Preço</th>
			<th scope="col">Categoria</th>
			<th scope="col">Tipo</th>
			<th scope="col">Cidade</th>
			<th scope="col">Bairro</th>
			<th scope="col">#</th>
		</tr>
	</thead>
	<tbody class="d-none"></tbody>
</table>

<div class="d-flex justify-content-center spinner">
	<div class="spinner-border text-light m-5" role="status">
		<span class="visually-hidden">Loading...</span>
	</div>
</div>

<div class="btn-toolbar" role="toolbar">
	<div class="btn-group me-2" role="group" aria-label="First group">
		<button type="button" class="btn btn-primary">1</button>
		<button type="button" class="btn btn-primary">2</button>
		<button type="button" class="btn btn-primary">3</button>
		<button type="button" class="btn btn-primary">4</button>
	</div>
</div>

<script>
	const Empreendimentos = fetch(`http://localhost:3001/api/empreendimentos${document.location.search}`)
	const Tabela = document.querySelector('tbody')
	const Spinner = document.querySelector('.spinner')

	Empreendimentos
		.then(response => response.json())
		.then(empreendimentos => {
			const options = {
				style: 'currency',
				currency: 'BRL',
				minimumIntegerDigits: 2
			}
			const Price = p => new Intl.NumberFormat('pt-BR', options).format(p)
			const Categoria = c => {
				const categorias = {
					"1": "Casa",
					"2": "Apartamento",
					"3": "Terreno",
					"4": "Lote",
					"5": "Kitnet",
				}
				return categorias[c]
			}
			const Type = t => {
				const type = {
					"1": "Venda",
					"2": "Aluguel"
				}
				return type[t]
			}
			const Result = empreendimentos.map(({ _id, title, price, status, categoria, cidade, bairro, type }) => {
				return (`<tr data-id="${_id}">
					<td>
						<a href="empreendimentos/show/${_id}" title="Editar empreendimento">${title}</a>
					</td>
					<td>${Price(price)}</td>
					<td><a href="?categoria=${categoria}">${Categoria(categoria)}</a></td>
					<td><a href="?type=${type}">${Type(type)}</a></td>
					<td><a href="?cidade=${cidade._id}">${cidade.name}</a></td>
					<td><a href="?cidade=${cidade._id}&bairro=${bairro._id}">${bairro.name}</a></td>
					<td class="text-center align-middle">
						<span class="badge bg-danger text-dark">
							<button type="button" class="btn-close btn-close-white erase" aria-label="Close" data-id="${_id}"></button>
						</span>
					</td>
				</tr>`)
			}).join('')

			Tabela.innerHTML += Result
			Tabela.classList.remove('d-none')
			Spinner.classList.add('d-none')

			// BOTÃO PARA EXCLUIR UM EMPREENDIMENTO
			document.querySelectorAll('.erase').forEach(e => {
				e.addEventListener('click', function (e) {
					const id = this.dataset.id
					if(confirm('Deseja realmente excluir esta publicação?')) {
						fetch('/api/empreendimentos', {
							method: 'DELETE',
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({ _id: id })
						})
						.then(response => response.json())
						.then(data => {
							console.log(document.querySelector(`tr[data-id="${id}"]`))
							document.querySelector(`tr[data-id="${id}"]`)
								.classList.add('d-none')
						})
						.catch(err => alert(err))
					}
				})
			})
		}).catch(err => console.error(err))
</script>