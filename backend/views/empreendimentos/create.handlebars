<h2 class="mb-5">Adicionar novo empreendimento</h2>

{{>_empreendimento_form}}

<script>
	const Cidades = fetch('/api/cidades/')

	const GetBairro = (cidade_id) => {
		bairroForm.innerHTML = null //LIMPA A LISTA ATUAL
		const Bairro = fetch('/api/bairros/' + cidade_id)
		Bairro.then(data => {
			data.json().then(bairros => {
				bairros.map(({ _id, name }) => {
					const Render = `<option value="${_id}">${name}</option>`
					bairroForm.innerHTML += Render
				})
				bairroForm.value = bairroForm.options[0].value
			})
		})
	}

	const GetCidade = async () => {
		Cidades.then(data => {
			data.json().then(cidades => {
				cidades.map(({ _id, name }) => {
					const Render = `<option value="${_id}">${name}</option>`
					cidadeForm.innerHTML += Render
				})
				cidadeForm.value = cidadeForm.options[0].value
				return GetBairro(cidadeForm.value)
			})
		})
	}

	const ShowImagesBox = () => {
		imagesBox.classList.add('show')
		imagesBox.scrollIntoView()
	}

	GetCidade()

	document.querySelector('[data-js="form_empreendimento"]')
		.addEventListener('submit', async function(e) {
			e.preventDefault()
			const response =
				await new Response(
					new URLSearchParams(new FormData(e.target).entries())
				).text()

			fetch('/api/empreendimentos/', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: response
			})
				.then(data => data.json()).then(body => {
					if(!body.errors) {
						sessionStorage.setItem('empreendimento_id', body)
						const BlockInputs = () => {
							const GetFormElements =
								document.querySelectorAll('form input, form textarea, form select')
							GetFormElements.forEach(e => e.disabled = true)
						}
						BlockInputs()
						ShowImagesBox()
						document.querySelector('#formulario .btn').innerText = 'Concluir'
					}
					const alertBox = document.querySelector('[data-js="alert"]')
					alertBox.children[0].innerHTML = "Ocorreu um erro, por favor, verifique as informações digitadas."
					alertBox.classList.toggle('visually-hidden')
					alertBox.scrollIntoView({ block: "end", behavior: "smooth" })
				})
				.catch(err => console.error(err))
		})

	cidadeForm.addEventListener('change', function (e) {GetBairro(this.value)})

	dropZone.ondragover = function () {
		this.classList.add('active')
		return false
	}
	dropZone.ondragleave = function () {
		this.classList.remove('active')
		return false
	}
	dropZone.ondrop = function (e) {
		const upload = files => {
			const data = new FormData()
			data.append('_id', sessionStorage.getItem('empreendimento_id'))

			for(x = 0; x < files.length; x++) {
				data.append('images[]', files[x])
			}

			fetch('/api/images/', {
				method: 'POST',
				body: data
			}).then(response => response.json().then(data => {
				const divImagens = document.getElementById('uploaded')

				data.forEach(({ filename, empreendimento }) => {
					const divImagem = document.createElement('div')
					divImagem.className = 'image'
					divImagem.style.backgroundImage = `url(/images/empreendimentos/${empreendimento}/${filename})`
					document.getElementById('uploaded').appendChild(divImagem)
				})
			})
			).catch(err => console.error(err))
		}
		e.preventDefault()
		upload(e.dataTransfer.files)
	}

	const alert_buttons = document.querySelector('[data-bs-dismiss="alert"]')
	alert_buttons.addEventListener('click', function (e) {
		e.preventDefault()
		e.path[1].classList.add('visually-hidden')
	})
</script>